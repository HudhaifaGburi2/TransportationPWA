-- =============================================
-- TUMS Phase 2: MEN Department Seed Data
-- This script is IDEMPOTENT - safe to run multiple times
-- =============================================

SET NOCOUNT ON;
BEGIN TRANSACTION;

BEGIN TRY
    PRINT 'Starting MEN Department data seed...';

    -- =============================================
    -- 1. Create MEN Department (if not exists)
    -- =============================================
    DECLARE @MenDepartmentId UNIQUEIDENTIFIER;
    
    SELECT @MenDepartmentId = DepartmentId 
    FROM Departments 
    WHERE Code = 'MEN' AND IsDeleted = 0;

    IF @MenDepartmentId IS NULL
    BEGIN
        SET @MenDepartmentId = NEWID();
        INSERT INTO Departments (DepartmentId, Code, NameAr, NameEn, IsActive, CreatedAt, IsDeleted)
        VALUES (@MenDepartmentId, 'MEN', N'قسم الرجال', 'Men Department', 1, GETUTCDATE(), 0);
        PRINT 'Created MEN Department with ID: ' + CAST(@MenDepartmentId AS NVARCHAR(50));
    END
    ELSE
    BEGIN
        PRINT 'MEN Department already exists with ID: ' + CAST(@MenDepartmentId AS NVARCHAR(50));
    END

    -- =============================================
    -- 2. Create Routes Table Variable for staging
    -- =============================================
    DECLARE @RoutesStaging TABLE (
        RouteName NVARCHAR(500),
        RouteId UNIQUEIDENTIFIER
    );

    -- Insert unique routes from the driver data
    INSERT INTO @RoutesStaging (RouteName, RouteId)
    SELECT DISTINCT RouteName, NULL
    FROM (VALUES
        (N'العزيزية مسلم'),
        (N'م . باقدو/ م . فهد'),
        (N'الكردي / السيح'),
        (N'الدعيثة ابو مرخة'),
        (N'الجرف الغربي'),
        (N'الصالحية'),
        (N'العنابس/ القبلتين / الغربية'),
        (N'العنابس (سكن الطلاب)/القبلتين/الفيصلية'),
        (N'الغربية / العنبرية / السقيا'),
        (N'المصانع / المستراح'),
        (N'المصانع/ المستراح'),
        (N'المستراح/السحمان'),
        (N'الروضة/الكويتية'),
        (N'السحمان / الروضة / الكويتية'),
        (N'العوالي'),
        (N'قربان / الخاتم / البحر'),
        (N'الأعمدة / شارع فلسطين'),
        (N'عروة /الوبرة'),
        (N'الرانوناء / شوران'),
        (N'الجرف الشرقى'),
        (N'العزيزية البخارى'),
        (N'الدعيثة'),
        (N'م طيبة / الدويمة/الظاهرة/العصبة'),
        (N'العوالي/السديري'),
        (N'م طيبة /الدويمة/ الظاهرة /العصبة'),
        (N'المغاربة /البحر/قربان'),
        (N'العنابس / القيلتين'),
        (N'الغربية/ العنابس'),
        (N'شوران / الروابي'),
        (N'مخطط الزهرة'),
        (N'مخطط الأمير نايف / القصواء'),
        (N'النصر'),
        (N'السديري / الحزام'),
        (N'الحزام / السديري'),
        (N'الخليل'),
        (N'الشهداء / الطيارية'),
        (N'الفيصلية/واحة السلام'),
        (N'الحرس / الشافية'),
        (N'البحر/الجمعة /العصبة'),
        (N'النسيم / الأزهري'),
        (N'التلال / الشيبية'),
        (N'الربوة'),
        (N'الخالدية'),
        (N'الخالدية/الاسكان الشمالي'),
        (N'العنابس'),
        (N'الحزام/المبعوث'),
        (N'مخطط الأمير تركي المطار'),
        (N'السحمان'),
        (N'الأعمدة ش فلسطين'),
        (N'الحزام/السديري'),
        (N'المغيسلة/الجبور/ الزاهدية'),
        (N'الكردي/السيح'),
        (N'العوالي /الحزام'),
        (N'الملك فهد'),
        (N'مهزور/الإسكان الجنوبي/الروابي'),
        (N'الربوة/ السديري/ السحمان/ الحزام'),
        (N'الوعير ط ينبع'),
        (N'م فهد/الاعمدة/العريض/الحزام'),
        (N'العريض/السديري'),
        (N'البحر/العوالي/الغربية/الجبور/عروة'),
        (N'قربان/البحر/العوالي'),
        (N'م .فهد / باقدو'),
        (N'الحزام/السديري/العوالي'),
        (N'السحمان/الأعمدة/شارع فلسطين'),
        (N'النصر/المستراح/المصانع'),
        (N'الأعمدة/السحمان/الكويتية/المستراح/النصر'),
        (N'م فهد/الحرس/الدويخلة/حمام الهناء'),
        (N'العزيزية/أبو مرخة/الدعيثة'),
        (N'القبلتين/الكردي/السيح/الجرف/البركة/العنابس'),
        (N'شوران/الخالدية/الهجرة/أبو بريقاء'),
        (N'الزاهدية/المغيسله/العنبرية/ الامام مسلم/الدفاع'),
        (N'شارع الملك عبدالعزيز/العوالي/الخاتم'),
        (N'الربوة / الصالحية'),
        (N'الجبور / الدويمة / الظاهرة / م. طيبة / المغاربة'),
        (N'النصر/ السحمان / الكردي'),
        (N'الأعمدة / ش. فلسطين / المبعوث'),
        (N'الأصفيرين / الغربية / السقيا / العنابس'),
        (N'العوالي / الحزام'),
        (N'الصالحية/الكويتية'),
        (N'الحزام/السديري/الإسكان'),
        (N'المصانع/المستراح/الشهداء/الطيارية'),
        (N'العنابس/القبلتين/الغربية'),
        (N'عروة/مخطط طيبة/العنبرية/الجبور/الزاهدية'),
        (N'الخالدية/الربوة/الإسكان'),
        (N'العوالي/البحر/قربان/الجمعة'),
        (N'النصر/الكردي/جمل الليل/القبلتين'),
        (N'الصالحية/الربوة/الخالدية'),
        (N'السحمان/الروضة/الكويتية'),
        (N'سلطانة'),
        (N'العنابس/الزاهدية/الجبور/الغربية')
    ) AS R(RouteName);

    -- Insert routes that don't exist
    INSERT INTO Routes (RouteId, RouteName, RouteDescription, IsActive, CreatedAt, IsDeleted)
    SELECT NEWID(), rs.RouteName, NULL, 1, GETUTCDATE(), 0
    FROM @RoutesStaging rs
    WHERE NOT EXISTS (
        SELECT 1 FROM Routes r WHERE r.RouteName = rs.RouteName AND r.IsDeleted = 0
    );

    PRINT 'Routes created/verified.';

    -- =============================================
    -- 3. Create Drivers and Buses from JSON data
    -- =============================================
    
    -- Create a staging table for driver/bus data
    DECLARE @DriversStaging TABLE (
        DriverName NVARCHAR(200),
        RouteName NVARCHAR(500),
        PhoneNumber NVARCHAR(20),
        Shift NVARCHAR(50),
        BusNumber NVARCHAR(10),
        PlateNumber NVARCHAR(20)
    );

    -- Insert all driver data
    INSERT INTO @DriversStaging VALUES
    -- العصر shift drivers
    (N'خالد كالى قهار', N'العزيزية مسلم', N'504353622', N'العصر', N'1', N'أ ط ع 8712'),
    (N'عبدالله أحمد بكر', N'م . باقدو/ م . فهد', N'590183677', N'العصر', N'2', N'أ ق ر 6202'),
    (N'الحسن حمي الأنصاري', N'الكردي / السيح', N'590616671', N'العصر', N'3', N'أ ر د 9128'),
    (N'محمد كمال الدين خيرى', N'الدعيثة ابو مرخة', N'539011026', N'العصر', N'4', N'ا ح ط 7027'),
    (N'عبدالله سالك الشنقيطي', N'الجرف الغربي', N'507840942', N'العصر', N'5', N'ا ع ك 8741'),
    (N'محمد حسين إبراهيم', N'الصالحية', N'506019013', N'العصر', N'6', N'ب ا د 7336'),
    (N'عمر سعيد أحمد', N'الصالحية', N'558348431', N'العصر', N'7', N'ا ي ل 3835'),
    (N'أحمد حكي صالح', N'الصالحية', N'504716809', N'العصر', N'8', N'ب ب ع 4421'),
    (N'مصطفى يحيى الحاج', N'العنابس/ القبلتين / الغربية', N'597898383', N'العصر', N'9', N'ب ب ع 5338'),
    (N'عيسى الحاج سوقي(عبدالإله)', N'العنابس (سكن الطلاب)/القبلتين/الفيصلية', N'547319113', N'العصر', N'10', N'ا ك ر 8540'),
    (N'عيسى حسن حكي', N'الغربية / العنبرية / السقيا', N'591318678', N'العصر', N'11', N'ا ن ع 3568'),
    (N'عبدالله عبدالمعين سعيد', N'المصانع / المستراح', N'576134660', N'العصر', N'12', N'ا ق ص 5264'),
    (N'عمر يوسف كوكومي', N'المصانع/ المستراح', N'598750124', N'العصر', N'13', N'ب ب ه 5993'),
    (N'سمير خالد', N'المستراح/السحمان', N'564902092', N'العصر', N'14', N'أ أ ل 4628'),
    (N'إبراهيم علي سوقي', N'الروضة/الكويتية', N'542332461', N'العصر', N'15', N'أ أ ق 3775'),
    (N'آدم علي طلاف', N'الكردي / السيح', N'567671415', N'العصر', N'16', N'ا د ص 1589'),
    (N'أمين الأنصاري', N'السحمان / الروضة / الكويتية', N'549257691', N'العصر', N'17', N'ا ط ح 7128'),
    (N'أبوبكر يوسف اسماعيل', N'العوالي', N'565665321', N'العصر', N'18', N'ا ل ي 1947'),
    (N'سعيد أحمد إدريس', N'قربان / الخاتم / البحر', N'599235341', N'العصر', N'19', N'ا ك ا 8190'),
    (N'أحمد عبدالمعين سعيد', N'الأعمدة / شارع فلسطين', N'549456989', N'العصر', N'20', N'ا ر ط 9296'),
    (N'أحمد شريف عمر', N'عروة /الوبرة', N'565546754', N'العصر', N'21', N'أ ق ر 2199'),
    (N'محمد ابكر محمد', N'الرانوناء / شوران', N'556437862', N'العصر', N'22', N'أ ل د 7724'),
    (N'صالح حسن محمد', N'الجرف الشرقى', N'580098172', N'العصر', N'23', N'ب ب ر 5439'),
    (N'أبويوسف', N'العزيزية البخارى', N'501046146', N'العصر', N'24', N'ب ط ا 8540'),
    (N'طاهر محمد سنوسى', N'الدعيثة', N'569634191', N'العصر', N'25', N'أ ي ل 3001'),
    (N'عبدالرزاق محمد زين', N'م طيبة / الدويمة/الظاهرة/العصبة', N'596575907', N'العصر', N'26', N'ط ق ا 2908'),
    (N'مختار حامد الأنصاري', N'العوالي/السديري', N'568129902', N'العصر', N'27', N'أ ر د 9129'),
    (N'عبدالرحمن علي بشير', N'م طيبة /الدويمة/ الظاهرة /العصبة', N'557357347', N'العصر', N'28', N'أ ق ر 5597'),
    (N'عبدالرحمن علي حسين', N'المغاربة /البحر/قربان', N'581060659', N'العصر', N'29', N'ب ع س 1786'),
    (N'صالح محمد احمد', N'العنابس / القيلتين', N'541473002', N'العصر', N'30', N'ب ح أ 6733'),
    (N'عبد الرحمن على شاوى', N'الغربية/ العنابس', N'573200350', N'العصر', N'31', N'أ م ن 7896'),
    (N'عبدالله محمد نور أبوماجد', N'شوران / الروابي', N'509378953', N'العصر', N'32', N'أ ون 6099'),
    (N'أمين محمد مرابط', N'مخطط الزهرة', N'583354071', N'العصر', N'33', N'أ ح د 2957'),
    (N'بكر عيسى دردرة', N'مخطط الأمير نايف / القصواء', N'582993895', N'العصر', N'41', N'ب ا ب 4818'),
    (N'أحمد علي سوقي', N'النصر', N'598342295', N'العصر', N'42', N'ب أ ط 4295'),
    (N'عبدالرزراق بابكر محمد', N'السديري / الحزام', N'537289021', N'العصر', N'43', N'ب ع م 4567'),
    (N'علي مختار محمد', N'الحزام / السديري', N'564530968', N'العصر', N'44', N'ب أ هـ 8951'),
    (N'أحمد عبدالواحد الأفغاني', N'الخليل', N'502078491', N'العصر', N'45', N'ا ق ه 6323'),
    (N'علي يوسف كوكومي', N'الشهداء / الطيارية', N'505281885', N'العصر', N'46', N'أ ل د 7926'),
    (N'إسحاق إبراهيم محمد', N'الفيصلية/واحة السلام', N'567485213', N'العصر', N'47', N'أ ك و6687'),
    (N'مختار محمد أحمد', N'الحرس / الشافية', N'582141915', N'العصر', N'48', N'ا م ر 8982'),
    (N'موسى الحاج الأنصاري', N'الشهداء / الطيارية', N'590304225', N'العصر', N'49', N'ب ط أ 8857'),
    (N'آدم طاهر علي', N'البحر/الجمعة /العصبة', N'544882246', N'العصر', N'50', N'ا ي ك 8924'),
    (N'أحمد إبراهيم عثمان', N'النسيم / الأزهري', N'540715863', N'العصر', N'51', N'ا ي ب 3163'),
    (N'حامد عمر النور', N'الصالحية', N'544351603', N'العصر', N'52', N'أ ح د 1139'),
    (N'حسام أمان الله', N'التلال / الشيبية', N'598932368', N'العصر', N'53', N'ا ط ح 6943'),
    (N'زكريا محمد نور', N'الربوة', N'', N'العصر', N'54', N'ا ط ح 6943'),
    (N'أمين محمود', N'الربوة', N'592344059', N'العصر', N'55', N'ا ر ل 3956'),
    (N'سعيد عبدالمعين سعيد', N'النصر', N'577113987', N'العصر', N'56', N'ا س ب 5990'),
    (N'يحيى آدم علي طلاف', N'النصر', N'567671415', N'العصر', N'57', N'ا ي ه 7519'),
    (N'عبدالعزيز عبدالله', N'الخالدية', N'531864209', N'العصر', N'58', N'ا ط ح 6944'),
    (N'حاج محمد صالح', N'الخالدية', N'553019034', N'العصر', N'59', N'ا ل م 3703'),
    (N'صلاح محمد الأمين', N'الخالدية/الاسكان الشمالي', N'532237621', N'العصر', N'60', N'ا ح ط 6947'),
    (N'يونس موسى يوسف', N'العنابس', N'544376360', N'العصر', N'61', N'ا ي ت 2046'),
    (N'محمد يوسف كوكومي', N'الصالحية', N'599700750', N'العصر', N'62', N'أ ل س 7615'),
    (N'إلياس محمد إسحاق', N'الحزام/المبعوث', N'546699971', N'العصر', N'63', N'أ د ص 1560'),
    (N'عيسى يوسف', N'مخطط الأمير تركي المطار', N'537289021', N'العصر', N'64', N'أ أ ل 4622'),
    (N'خالد محمد المصطفى', N'السحمان', N'543528102', N'العصر', N'65', N'ا ط ح 6949'),
    (N'عبدالله محمد نور موسى', N'الأعمدة ش فلسطين', N'544552365', N'العصر', N'66', N'أ ق ص 5950'),
    (N'محمد موسى علي', N'الحزام/السديري', N'597598543', N'العصر', N'67', N'أ ح ي 9698'),
    (N'أسامة الشنقيطي', N'المغيسلة/الجبور/ الزاهدية', N'564730176', N'العصر', N'68', N'ا ط ح 6907'),
    (N'عبدالرحمن آدم صالح', N'الكردي/السيح', N'568065524', N'العصر', N'69', N'أ ن ي 1352'),
    (N'محمد أحمد الشريف', N'الربوة', N'580054244', N'العصر', N'70', N'أ ي ح 8259'),
    (N'حمزة حامد محمد نور', N'العوالي /الحزام', N'565548169', N'العصر', N'71', N'أ ي ل 3626'),
    (N'حسين علي دردرة', N'المغيسلة/الجبور/ الزاهدية', N'544882246', N'العصر', N'72', N'أ أ ر 7112'),
    (N'يحي عبدالله يحي', N'الملك فهد', N'543125857', N'العصر', N'73', N'أ ع هـ9665'),
    (N'عمر ادريس محمد', N'مهزور/الإسكان الجنوبي/الروابي', N'578997082', N'العصر', N'74', N'أ و ص 6775'),
    (N'آدم محمد نور', N'الربوة/ السديري/ السحمان/ الحزام', N'562315136', N'العصر', N'91', N'أ م ب 9075'),
    (N'أولان سليف', N'الوعير ط ينبع', N'568294415', N'العصر', N'94', N'أ ي ن 3051'),
    (N'عبدالعظيم العطا', N'م فهد/الاعمدة/العريض/الحزام', N'544042489', N'العصر', N'408', N'أ ط ب 9251'),
    -- المغرب shift drivers
    (N'بشير حامد حسن', N'العريض/السديري', N'561510651', N'المغرب', N'409', N'أ ط ع 7911'),
    (N'عبدل محمد خان', N'البحر/العوالي/الغربية/الجبور/عروة', N'566662715', N'العصر', N'410', N'أ م ر 9936'),
    (N'يحيى آدم طلاف', N'الصالحية', N'566692048', N'المغرب', N'301', N'أ ي هـ 7519'),
    (N'عبدالله محمد نور موسى', N'الربوة', N'544552365', N'المغرب', N'302', N'أ ق ص 5950'),
    (N'أحمد حكي صالح', N'السحمان', N'538989880', N'المغرب', N'303', N'ب ب ع 4421'),
    (N'آدم علي طلاف', N'الكردي/السيح', N'567671415', N'المغرب', N'304', N'أ د ص 1589'),
    (N'محمد آدم كرم', N'الخالدية', N'561510651', N'المغرب', N'305', N'أ ط ع 7911'),
    (N'علي يوسف كوكومي', N'النصر', N'505281885', N'المغرب', N'306', N'أ ل د 7926'),
    (N'محمد يوسف كوكومي', N'العنابس/الزاهدية/الجبور/الغربية', N'599700750', N'المغرب', N'307', N'أ ل س 7615'),
    (N'عيسى محمد شريف', N'قربان/البحر/العوالي', N'509894357', N'المغرب', N'308', N'أ ح د 3395'),
    (N'طاهر محمد سنوسي', N'م .فهد / باقدو', N'569634191', N'المغرب', N'309', N'أ ي ل 3001'),
    (N'عبدالله محمد أبو ماجد', N'الحزام/السديري/العوالي', N'509378953', N'المغرب', N'310', N'أ ون 6099'),
    (N'الحسن حمي', N'الصالحية', N'590616671', N'المغرب', N'311', N'أ ر د 9128'),
    (N'عيسى يوسف جاسبو', N'السحمان/الأعمدة/شارع فلسطين', N'537289021', N'المغرب', N'312', N'أ أ ل 4622'),
    (N'عمر يوسف كوكومي', N'النصر/المستراح/المصانع', N'598750124', N'المغرب', N'313', N'ب ب هـ 5993'),
    (N'موسى محمد زين', N'الأعمدة/السحمان/الكويتية/المستراح/النصر', N'590004084', N'المغرب', N'401', N'ط ق ر 2908'),
    (N'موسى الحاج الأنصاري', N'م فهد/الحرس/الدويخلة/حمام الهناء', N'590304225', N'المغرب', N'402', N'أ وص 6775'),
    (N'أحمد علي سوقي', N'العزيزية/أبو مرخة/الدعيثة', N'598342295', N'المغرب', N'403', N'ب أ ط 4295'),
    (N'أيوب آدم صالح', N'القبلتين/الكردي/السيح/الجرف/البركة/العنابس', N'568065524', N'المغرب', N'404', N'أ ن ي 1352'),
    (N'حسن علي سدر', N'شوران/الخالدية/الهجرة/أبو بريقاء', N'568129902', N'المغرب', N'405', N'أ د هـ 560'),
    (N'إلياس محمد إسحاق', N'الزاهدية/المغيسله/العنبرية/ الامام مسلم/الدفاع', N'546699971', N'المغرب', N'406', N'أ د ص 1560'),
    (N'كرم عطية', N'شارع الملك عبدالعزيز/العوالي/الخاتم', N'564061866', N'المغرب', N'407', N'أ م س 5499'),
    -- الفجر shift drivers
    (N'احمد علي سوقي', N'الربوة / الصالحية', N'598342295', N'الفجر', N'101', N'ب أ ط 4295'),
    (N'عبد الله نور أبو ماجد', N'الجبور / الدويمة / الظاهرة / م. طيبة / المغاربة', N'509378953', N'الفجر', N'102', N'أ و ن 6099'),
    (N'عبد الله محمد موسي', N'النصر/ السحمان / الكردي', N'544552365', N'الفجر', N'103', N'أ ق ص 5950'),
    (N'آدم علي طلاف', N'الأعمدة / ش. فلسطين / المبعوث', N'567671415', N'الفجر', N'104', N'ب أ ك 5802'),
    (N'محمد أبكر محمد', N'الأصفيرين / الغربية / السقيا / العنابس', N'556437862', N'الفجر', N'105', N'أ ل د 7724'),
    (N'كرم عطية', N'العوالي / الحزام', N'564061866', N'الفجر', N'106', N'أ ط ع 7911'),
    -- الضحى shift drivers
    (N'سمير خالد', N'الصالحية/الكويتية', N'564902092', N'الضحى', N'201', N'أ أ ل 4628'),
    (N'محمد موسى علي', N'الحزام/السديري/الإسكان', N'597598543', N'الضحى', N'202', N'ب أ ك 5802'),
    (N'يحي آدم على طلاف', N'المصانع/المستراح/الشهداء/الطيارية', N'566692048', N'الضحى', N'203', N'أ ي أ 8763'),
    (N'أسحاق إبراهيم موسى', N'العنابس/القبلتين/الغربية', N'567485213', N'الضحى', N'204', N'ب أ ك 5802'),
    (N'حامد عمر النور', N'السحمان/الأعمدة/شارع فلسطين', N'544351603', N'الضحى', N'205', N'أ ح د 2992'),
    (N'آدم علي', N'عروة/مخطط طيبة/العنبرية/الجبور/الزاهدية', N'567671415', N'الضحى', N'206', N'ب أ ك 5802'),
    (N'ابوبكر حسين', N'الخالدية/الربوة/الإسكان', N'545680592', N'الضحى', N'207', N'ب ر ي 1401'),
    (N'موسى محمد زين', N'العوالي/البحر/قربان/الجمعة', N'590004084', N'الضحى', N'208', N'ب ص هـ 8214'),
    (N'علي محمد اسحق', N'النصر/الكردي/جمل الليل/القبلتين', N'546699971', N'الضحى', N'209', N'أ د ص 1560'),
    (N'إبراهيم على سوقي', N'الصالحية/الربوة/الخالدية', N'542332461', N'الضحى', N'210', N'أ و ن 6099'),
    (N'عبد الله محمد أبو ماجد', N'السحمان/الروضة/الكويتية', N'509378953', N'الضحى', N'211', N'ب أ ك 5802'),
    (N'عبد الرحمن علي بشير', N'الصالحية', N'557357347', N'الضحى', N'212', N'أ ق ر 5597'),
    (N'عبدالمنعم احمد', N'سلطانة', N'554611208', N'الضحى', N'213', N'أ د و 9228');

    PRINT 'Driver staging data inserted.';

    -- Map shift names to period IDs (based on Central DB SetPeriod table)
    -- العصر = 2, المغرب = 3, الفجر = 1, الضحى = 4 (typical mapping)
    DECLARE @ShiftToPeriod TABLE (ShiftName NVARCHAR(50), PeriodId INT);
    INSERT INTO @ShiftToPeriod VALUES 
        (N'الفجر', 1),
        (N'العصر', 2),
        (N'المغرب', 3),
        (N'الضحى', 4);

    -- Insert drivers that don't exist (based on phone number uniqueness within department)
    INSERT INTO Drivers (DriverId, FullName, PhoneNumber, DepartmentId, IsActive, CreatedAt, IsDeleted)
    SELECT NEWID(), ds.DriverName, ds.PhoneNumber, @MenDepartmentId, 1, GETUTCDATE(), 0
    FROM (
        SELECT DISTINCT DriverName, PhoneNumber
        FROM @DriversStaging
        WHERE PhoneNumber IS NOT NULL AND PhoneNumber <> ''
    ) ds
    WHERE NOT EXISTS (
        SELECT 1 FROM Drivers d 
        WHERE d.PhoneNumber = ds.PhoneNumber 
          AND d.DepartmentId = @MenDepartmentId 
          AND d.IsDeleted = 0
    );

    PRINT 'Drivers created/verified.';

    -- Insert buses that don't exist (based on PlateNumber + PeriodId uniqueness)
    INSERT INTO Buses (BusId, PlateNumber, BusNumber, PeriodId, RouteId, DriverId, DepartmentId, Capacity, IsActive, IsMerged, CreatedAt, IsDeleted)
    SELECT 
        NEWID(),
        ds.PlateNumber,
        ds.BusNumber,
        sp.PeriodId,
        r.RouteId,
        d.DriverId,
        @MenDepartmentId,
        30, -- Default capacity
        1,  -- IsActive
        0,  -- IsMerged
        GETUTCDATE(),
        0   -- IsDeleted
    FROM @DriversStaging ds
    INNER JOIN @ShiftToPeriod sp ON ds.Shift = sp.ShiftName
    LEFT JOIN Routes r ON r.RouteName = ds.RouteName AND r.IsDeleted = 0
    LEFT JOIN Drivers d ON d.PhoneNumber = ds.PhoneNumber AND d.DepartmentId = @MenDepartmentId AND d.IsDeleted = 0
    WHERE NOT EXISTS (
        SELECT 1 FROM Buses b 
        WHERE b.PlateNumber = ds.PlateNumber 
          AND b.PeriodId = sp.PeriodId 
          AND b.IsDeleted = 0
    );

    PRINT 'Buses created/verified.';

    -- Summary
    DECLARE @DepartmentCount INT, @RouteCount INT, @DriverCount INT, @BusCount INT;
    SELECT @DepartmentCount = COUNT(*) FROM Departments WHERE IsDeleted = 0;
    SELECT @RouteCount = COUNT(*) FROM Routes WHERE IsDeleted = 0;
    SELECT @DriverCount = COUNT(*) FROM Drivers WHERE DepartmentId = @MenDepartmentId AND IsDeleted = 0;
    SELECT @BusCount = COUNT(*) FROM Buses WHERE DepartmentId = @MenDepartmentId AND IsDeleted = 0;

    PRINT '========================================';
    PRINT 'Seed completed successfully!';
    PRINT 'Total Departments: ' + CAST(@DepartmentCount AS NVARCHAR(10));
    PRINT 'Total Routes: ' + CAST(@RouteCount AS NVARCHAR(10));
    PRINT 'MEN Drivers: ' + CAST(@DriverCount AS NVARCHAR(10));
    PRINT 'MEN Buses: ' + CAST(@BusCount AS NVARCHAR(10));
    PRINT '========================================';

    COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    ROLLBACK TRANSACTION;
    PRINT 'Error occurred during seed:';
    PRINT ERROR_MESSAGE();
    THROW;
END CATCH
