-- =============================================
-- TUMS Phase 2: MEN Department Seed Data
-- Works with ACTUAL database schema
-- This script is IDEMPOTENT - safe to run multiple times
-- =============================================

SET NOCOUNT ON;
BEGIN TRANSACTION;

BEGIN TRY
    PRINT 'Starting MEN Department data seed...';

    -- =============================================
    -- 1. Insert Drivers (if not exists by PhoneNumber)
    -- =============================================
    
    -- Create staging table for drivers
    DECLARE @DriversData TABLE (
        FullName NVARCHAR(200),
        PhoneNumber NVARCHAR(20),
        RouteName NVARCHAR(500),
        Shift NVARCHAR(50),
        BusNumber NVARCHAR(10),
        PlateNumber NVARCHAR(20)
    );

    -- Insert all driver data from MEN department
    INSERT INTO @DriversData VALUES
    -- العصر shift drivers
    (N'خالد كالى قهار', N'504353622', N'العزيزية مسلم', N'العصر', N'1', N'أ ط ع 8712'),
    (N'عبدالله أحمد بكر', N'590183677', N'م . باقدو/ م . فهد', N'العصر', N'2', N'أ ق ر 6202'),
    (N'الحسن حمي الأنصاري', N'590616671', N'الكردي / السيح', N'العصر', N'3', N'أ ر د 9128'),
    (N'محمد كمال الدين خيرى', N'539011026', N'الدعيثة ابو مرخة', N'العصر', N'4', N'ا ح ط 7027'),
    (N'عبدالله سالك الشنقيطي', N'507840942', N'الجرف الغربي', N'العصر', N'5', N'ا ع ك 8741'),
    (N'محمد حسين إبراهيم', N'506019013', N'الصالحية', N'العصر', N'6', N'ب ا د 7336'),
    (N'عمر سعيد أحمد', N'558348431', N'الصالحية', N'العصر', N'7', N'ا ي ل 3835'),
    (N'أحمد حكي صالح', N'504716809', N'الصالحية', N'العصر', N'8', N'ب ب ع 4421'),
    (N'مصطفى يحيى الحاج', N'597898383', N'العنابس/ القبلتين / الغربية', N'العصر', N'9', N'ب ب ع 5338'),
    (N'عيسى الحاج سوقي(عبدالإله)', N'547319113', N'العنابس (سكن الطلاب)/القبلتين/الفيصلية', N'العصر', N'10', N'ا ك ر 8540'),
    (N'عيسى حسن حكي', N'591318678', N'الغربية / العنبرية / السقيا', N'العصر', N'11', N'ا ن ع 3568'),
    (N'عبدالله عبدالمعين سعيد', N'576134660', N'المصانع / المستراح', N'العصر', N'12', N'ا ق ص 5264'),
    (N'عمر يوسف كوكومي', N'598750124', N'المصانع/ المستراح', N'العصر', N'13', N'ب ب ه 5993'),
    (N'سمير خالد', N'564902092', N'المستراح/السحمان', N'العصر', N'14', N'أ أ ل 4628'),
    (N'إبراهيم علي سوقي', N'542332461', N'الروضة/الكويتية', N'العصر', N'15', N'أ أ ق 3775'),
    (N'آدم علي طلاف', N'567671415', N'الكردي / السيح', N'العصر', N'16', N'ا د ص 1589'),
    (N'أمين الأنصاري', N'549257691', N'السحمان / الروضة / الكويتية', N'العصر', N'17', N'ا ط ح 7128'),
    (N'أبوبكر يوسف اسماعيل', N'565665321', N'العوالي', N'العصر', N'18', N'ا ل ي 1947'),
    (N'سعيد أحمد إدريس', N'599235341', N'قربان / الخاتم / البحر', N'العصر', N'19', N'ا ك ا 8190'),
    (N'أحمد عبدالمعين سعيد', N'549456989', N'الأعمدة / شارع فلسطين', N'العصر', N'20', N'ا ر ط 9296'),
    (N'أحمد شريف عمر', N'565546754', N'عروة /الوبرة', N'العصر', N'21', N'أ ق ر 2199'),
    (N'محمد ابكر محمد', N'556437862', N'الرانوناء / شوران', N'العصر', N'22', N'أ ل د 7724'),
    (N'صالح حسن محمد', N'580098172', N'الجرف الشرقى', N'العصر', N'23', N'ب ب ر 5439'),
    (N'أبويوسف', N'501046146', N'العزيزية البخارى', N'العصر', N'24', N'ب ط ا 8540'),
    (N'طاهر محمد سنوسى', N'569634191', N'الدعيثة', N'العصر', N'25', N'أ ي ل 3001'),
    (N'عبدالرزاق محمد زين', N'596575907', N'م طيبة / الدويمة/الظاهرة/العصبة', N'العصر', N'26', N'ط ق ا 2908'),
    (N'مختار حامد الأنصاري', N'568129902', N'العوالي/السديري', N'العصر', N'27', N'أ ر د 9129'),
    (N'عبدالرحمن علي بشير', N'557357347', N'م طيبة /الدويمة/ الظاهرة /العصبة', N'العصر', N'28', N'أ ق ر 5597'),
    (N'عبدالرحمن علي حسين', N'581060659', N'المغاربة /البحر/قربان', N'العصر', N'29', N'ب ع س 1786'),
    (N'صالح محمد احمد', N'541473002', N'العنابس / القيلتين', N'العصر', N'30', N'ب ح أ 6733'),
    (N'عبد الرحمن على شاوى', N'573200350', N'الغربية/ العنابس', N'العصر', N'31', N'أ م ن 7896'),
    (N'عبدالله محمد نور أبوماجد', N'509378953', N'شوران / الروابي', N'العصر', N'32', N'أ ون 6099'),
    (N'أمين محمد مرابط', N'583354071', N'مخطط الزهرة', N'العصر', N'33', N'أ ح د 2957'),
    (N'بكر عيسى دردرة', N'582993895', N'مخطط الأمير نايف / القصواء', N'العصر', N'41', N'ب ا ب 4818'),
    (N'أحمد علي سوقي', N'598342295', N'النصر', N'العصر', N'42', N'ب أ ط 4295'),
    (N'عبدالرزراق بابكر محمد', N'537289021', N'السديري / الحزام', N'العصر', N'43', N'ب ع م 4567'),
    (N'علي مختار محمد', N'564530968', N'الحزام / السديري', N'العصر', N'44', N'ب أ هـ 8951'),
    (N'أحمد عبدالواحد الأفغاني', N'502078491', N'الخليل', N'العصر', N'45', N'ا ق ه 6323'),
    (N'علي يوسف كوكومي', N'505281885', N'الشهداء / الطيارية', N'العصر', N'46', N'أ ل د 7926'),
    (N'إسحاق إبراهيم محمد', N'567485213', N'الفيصلية/واحة السلام', N'العصر', N'47', N'أ ك و6687'),
    (N'مختار محمد أحمد', N'582141915', N'الحرس / الشافية', N'العصر', N'48', N'ا م ر 8982'),
    (N'موسى الحاج الأنصاري', N'590304225', N'الشهداء / الطيارية', N'العصر', N'49', N'ب ط أ 8857'),
    (N'آدم طاهر علي', N'544882246', N'البحر/الجمعة /العصبة', N'العصر', N'50', N'ا ي ك 8924'),
    (N'أحمد إبراهيم عثمان', N'540715863', N'النسيم / الأزهري', N'العصر', N'51', N'ا ي ب 3163'),
    (N'حامد عمر النور', N'544351603', N'الصالحية', N'العصر', N'52', N'أ ح د 1139'),
    (N'حسام أمان الله', N'598932368', N'التلال / الشيبية', N'العصر', N'53', N'ا ط ح 6943'),
    (N'أمين محمود', N'592344059', N'الربوة', N'العصر', N'55', N'ا ر ل 3956'),
    (N'سعيد عبدالمعين سعيد', N'577113987', N'النصر', N'العصر', N'56', N'ا س ب 5990'),
    (N'يحيى آدم علي طلاف', N'567671415', N'النصر', N'العصر', N'57', N'ا ي ه 7519'),
    (N'عبدالعزيز عبدالله', N'531864209', N'الخالدية', N'العصر', N'58', N'ا ط ح 6944'),
    (N'حاج محمد صالح', N'553019034', N'الخالدية', N'العصر', N'59', N'ا ل م 3703'),
    (N'صلاح محمد الأمين', N'532237621', N'الخالدية/الاسكان الشمالي', N'العصر', N'60', N'ا ح ط 6947'),
    (N'يونس موسى يوسف', N'544376360', N'العنابس', N'العصر', N'61', N'ا ي ت 2046'),
    (N'محمد يوسف كوكومي', N'599700750', N'الصالحية', N'العصر', N'62', N'أ ل س 7615'),
    (N'إلياس محمد إسحاق', N'546699971', N'الحزام/المبعوث', N'العصر', N'63', N'أ د ص 1560'),
    (N'عيسى يوسف', N'537289021', N'مخطط الأمير تركي المطار', N'العصر', N'64', N'أ أ ل 4622'),
    (N'خالد محمد المصطفى', N'543528102', N'السحمان', N'العصر', N'65', N'ا ط ح 6949'),
    (N'عبدالله محمد نور موسى', N'544552365', N'الأعمدة ش فلسطين', N'العصر', N'66', N'أ ق ص 5950'),
    (N'محمد موسى علي', N'597598543', N'الحزام/السديري', N'العصر', N'67', N'أ ح ي 9698'),
    (N'أسامة الشنقيطي', N'564730176', N'المغيسلة/الجبور/ الزاهدية', N'العصر', N'68', N'ا ط ح 6907'),
    (N'عبدالرحمن آدم صالح', N'568065524', N'الكردي/السيح', N'العصر', N'69', N'أ ن ي 1352'),
    (N'محمد أحمد الشريف', N'580054244', N'الربوة', N'العصر', N'70', N'أ ي ح 8259'),
    (N'حمزة حامد محمد نور', N'565548169', N'العوالي /الحزام', N'العصر', N'71', N'أ ي ل 3626'),
    (N'حسين علي دردرة', N'544882246', N'المغيسلة/الجبور/ الزاهدية', N'العصر', N'72', N'أ أ ر 7112'),
    (N'يحي عبدالله يحي', N'543125857', N'الملك فهد', N'العصر', N'73', N'أ ع هـ9665'),
    (N'عمر ادريس محمد', N'578997082', N'مهزور/الإسكان الجنوبي/الروابي', N'العصر', N'74', N'أ و ص 6775'),
    (N'آدم محمد نور', N'562315136', N'الربوة/ السديري/ السحمان/ الحزام', N'العصر', N'91', N'أ م ب 9075'),
    (N'أولان سليف', N'568294415', N'الوعير ط ينبع', N'العصر', N'94', N'أ ي ن 3051'),
    (N'عبدالعظيم العطا', N'544042489', N'م فهد/الاعمدة/العريض/الحزام', N'العصر', N'408', N'أ ط ب 9251'),
    -- المغرب shift drivers
    (N'بشير حامد حسن', N'561510651', N'العريض/السديري', N'المغرب', N'409', N'أ ط ع 7911'),
    (N'عبدل محمد خان', N'566662715', N'البحر/العوالي/الغربية/الجبور/عروة', N'العصر', N'410', N'أ م ر 9936'),
    (N'يحيى آدم طلاف', N'566692048', N'الصالحية', N'المغرب', N'301', N'أ ي هـ 7519'),
    (N'عيسى محمد شريف', N'509894357', N'قربان/البحر/العوالي', N'المغرب', N'308', N'أ ح د 3395'),
    (N'موسى محمد زين', N'590004084', N'الأعمدة/السحمان/الكويتية/المستراح/النصر', N'المغرب', N'401', N'ط ق ر 2908'),
    (N'أيوب آدم صالح', N'568065524', N'القبلتين/الكردي/السيح/الجرف/البركة/العنابس', N'المغرب', N'404', N'أ ن ي 1352'),
    (N'حسن علي سدر', N'568129902', N'شوران/الخالدية/الهجرة/أبو بريقاء', N'المغرب', N'405', N'أ د هـ 560'),
    (N'كرم عطية', N'564061866', N'شارع الملك عبدالعزيز/العوالي/الخاتم', N'المغرب', N'407', N'أ م س 5499'),
    -- الفجر shift drivers  
    (N'ابوبكر حسين', N'545680592', N'الخالدية/الربوة/الإسكان', N'الضحى', N'207', N'ب ر ي 1401'),
    (N'عبدالمنعم احمد', N'554611208', N'سلطانة', N'الضحى', N'213', N'أ د و 9228');

    PRINT 'Driver staging data prepared.';

    -- Insert unique drivers that don't exist (by PhoneNumber)
    -- Use ROW_NUMBER to generate unique license numbers
    INSERT INTO Drivers (Id, FullName, PhoneNumber, LicenseNumber, LicenseExpiryDate, IsActive, CreatedAt)
    SELECT NEWID(), dd.FullName, dd.PhoneNumber, 'MEN-DRV-' + CAST(dd.RowNum AS NVARCHAR(10)) + '-' + dd.PhoneNumber, DATEADD(YEAR, 2, GETUTCDATE()), 1, GETUTCDATE()
    FROM (
        SELECT DISTINCT FullName, PhoneNumber, ROW_NUMBER() OVER (ORDER BY PhoneNumber) AS RowNum
        FROM @DriversData
        WHERE PhoneNumber IS NOT NULL AND PhoneNumber <> ''
    ) dd
    WHERE NOT EXISTS (
        SELECT 1 FROM Drivers d WHERE d.PhoneNumber = dd.PhoneNumber
    );

    DECLARE @DriversInserted INT = @@ROWCOUNT;
    PRINT 'Drivers inserted: ' + CAST(@DriversInserted AS NVARCHAR(10));

    -- =============================================
    -- 2. Insert Routes (if not exists by Name)
    -- =============================================
    
    -- Get unique route names
    DECLARE @RoutesData TABLE (RouteName NVARCHAR(500));
    INSERT INTO @RoutesData
    SELECT DISTINCT RouteName FROM @DriversData;

    -- Insert routes that don't exist
    INSERT INTO Routes (Id, Name, Code, District, MeetingPoint, PickupTime, DropoffTime, Capacity, Status, CreatedAt)
    SELECT 
        NEWID(), 
        rd.RouteName, 
        'MEN-' + CAST(ROW_NUMBER() OVER (ORDER BY rd.RouteName) AS NVARCHAR(10)),
        N'المدينة المنورة',
        N'نقطة التجمع',
        '15:00:00',
        '17:00:00',
        30,
        1,
        GETUTCDATE()
    FROM @RoutesData rd
    WHERE NOT EXISTS (
        SELECT 1 FROM Routes r WHERE r.Name = rd.RouteName
    );

    DECLARE @RoutesInserted INT = @@ROWCOUNT;
    PRINT 'Routes inserted: ' + CAST(@RoutesInserted AS NVARCHAR(10));

    -- =============================================
    -- 3. Insert Buses (if not exists by LicensePlate)
    -- Use MIN to get unique plate numbers (same plate may appear in multiple shifts)
    -- =============================================
    
    INSERT INTO Buses (Id, BusNumber, LicensePlate, Capacity, Status, CreatedAt)
    SELECT 
        NEWID(),
        dd.BusNumber,
        dd.PlateNumber,
        30,
        1,
        GETUTCDATE()
    FROM (
        SELECT PlateNumber, MIN(BusNumber) AS BusNumber
        FROM @DriversData
        GROUP BY PlateNumber
    ) dd
    WHERE NOT EXISTS (
        SELECT 1 FROM Buses b WHERE b.LicensePlate = dd.PlateNumber
    );

    DECLARE @BusesInserted INT = @@ROWCOUNT;
    PRINT 'Buses inserted: ' + CAST(@BusesInserted AS NVARCHAR(10));

    -- =============================================
    -- Summary
    -- =============================================
    DECLARE @TotalDrivers INT, @TotalRoutes INT, @TotalBuses INT;
    SELECT @TotalDrivers = COUNT(*) FROM Drivers;
    SELECT @TotalRoutes = COUNT(*) FROM Routes;
    SELECT @TotalBuses = COUNT(*) FROM Buses;

    PRINT '========================================';
    PRINT 'Seed completed successfully!';
    PRINT 'Total Drivers: ' + CAST(@TotalDrivers AS NVARCHAR(10));
    PRINT 'Total Routes: ' + CAST(@TotalRoutes AS NVARCHAR(10));
    PRINT 'Total Buses: ' + CAST(@TotalBuses AS NVARCHAR(10));
    PRINT '========================================';

    COMMIT TRANSACTION;
END TRY
BEGIN CATCH
    ROLLBACK TRANSACTION;
    PRINT 'Error occurred during seed:';
    PRINT ERROR_MESSAGE();
    THROW;
END CATCH
